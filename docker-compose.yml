# CyberThreat_Ops Infrastructure Stack
# Run: docker compose up -d

services:
  influxdb:
    image: influxdb:2.7
    container_name: cyberops_influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=adminpassword
      - DOCKER_INFLUXDB_INIT_ORG=cyberops
      - DOCKER_INFLUXDB_INIT_BUCKET=monitoring
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=cyberops-token-2026
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - cyberops_network

  redis:
    image: redis:7-alpine
    container_name: cyberops_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - cyberops_network

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: cyberops_rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - cyberops_network

  grafana:
    image: grafana/grafana:10.2.3
    container_name: cyberops_grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_INSTALL_PLUGINS=grafana-clock-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./config/grafana:/etc/grafana/provisioning
    networks:
      - cyberops_network
    depends_on:
      - influxdb

  # API runs locally for development
  # Uncomment for production deployment
  # api:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile
  #   container_name: cyberops_api
  #   ports:
  #     - "8000:8000"
  #   environment:
  #     - INFLUXDB_URL=http://influxdb:8086
  #     - INFLUXDB_TOKEN=cyberops-token-2026
  #     - INFLUXDB_ORG=cyberops
  #     - INFLUXDB_BUCKET=monitoring
  #     - REDIS_HOST=redis
  #     - REDIS_PORT=6379
  #     - RABBITMQ_HOST=rabbitmq
  #     - RABBITMQ_PORT=5672
  #   volumes:
  #     - ./src:/app/src
  #     - ./config:/app/config
  #     - ./logs:/app/logs
  #   networks:
  #     - cyberops_network
  #   depends_on:
  #     - influxdb
  #     - redis
  #     - rabbitmq
  #   command: uvicorn src.api.main:app --host 0.0.0.0 --port 8000 --reload

volumes:
  influxdb_data:
  redis_data:
  rabbitmq_data:
  grafana_data:

networks:
  cyberops_network:
    driver: bridge
